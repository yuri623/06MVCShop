<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="PurchaseMapper">
 	
 	<resultMap id="productResult" type="com.model2.mvc.service.domain.Product">
		<result property="prodNo" 			column="prod_no" 			jdbcType="NUMERIC"/>
		<result property="prodName"	column="prod_name" 		jdbcType="VARCHAR" />
		<result property="prodDetail" 	column="prod_detail" 		jdbcType="VARCHAR" />
		<result property="manuDate" 				column="manufacture_day" 					jdbcType="VARCHAR" />
		<result property="price" 				column="price" 					jdbcType="NUMERIC" />
		<result property="fileName" 			column="image_file" 		jdbcType="VARCHAR" />
		<result property="regDate" 				column="reg_date" 					jdbcType="DATE" />
		<result property="proTranCode" 				column="tran_status_code" 					jdbcType="VARCHAR" />
	</resultMap>
	
	<resultMap id="userResult" type="com.model2.mvc.service.domain.User">
		<result property="userId" 			column="user_id" 			jdbcType="VARCHAR"/>
		<result property="userName"	column="user_name" 		jdbcType="VARCHAR" />
		<result property="password" 	column="password" 		jdbcType="VARCHAR" />
		<result property="role" 				column="role" 					jdbcType="VARCHAR" />
		<result property="ssn" 				column="ssn" 					jdbcType="VARCHAR" />
		<result property="phone" 			column="cell_phone" 		jdbcType="VARCHAR" />
		<result property="addr" 				column="addr" 					jdbcType="VARCHAR" />
		<result property="email" 			column="email" 				jdbcType="NUMERIC"  />
		<result property="regDate" 		column="reg_date" 			jdbcType="DATE" />
	</resultMap>
 	
	<resultMap id="purchaseSelectMap" type="com.model2.mvc.service.domain.Purchase">
		<result property="tranNo" 			column="tran_no" 			jdbcType="NUMERIC"/>
		<result property="buyer"	column="buyer_id" 		jdbcType="VARCHAR" />
		<result property="paymentOption" 	column="payment_option" 		jdbcType="CHAR" />
		<result property="receiverName" 				column="receiver_name" 					jdbcType="VARCHAR" />
		<result property="receiverPhone" 				column="receiver_phone" 					jdbcType="VARCHAR" />
		<result property="divyAddr" 				column="dlvy_addr" 					jdbcType="VARCHAR" />
		<result property="divyRequest" 				column="dlvy_request" 					jdbcType="VARCHAR" />
		<result property="tranCode" 				column="tran_status_code" 					jdbcType="NUMERIC" />
		<result property="orderDate" 			column="order_date" 		jdbcType="DATE" />
		<result property="divyDate" 				column="dlvy_date" 					jdbcType="DATE" />
		<association property="purchaseProd"  column="prod_no" javaType="com.model2.mvc.service.domain.Product" select="selectProduct"/>
		<association property="buyer" column="buyer_id" javaType="com.model2.mvc.service.domain.User" select="selectUser"/>
	</resultMap>
	
	<select id="selectUser" resultMap="userResult">
		SELECT * FROM users WHERE user_id=#{id}
	</select>
	
	<select id="selectProduct" resultMap="productResult">
		SELECT * FROM product WHERE prod_no=#{id}
	</select>
	
	<!-- product의 Create(insert) ok-->
	<insert id="addPurchase" parameterType="com.model2.mvc.service.domain.Purchase">
		INSERT INTO transaction(tran_no, prod_no, buyer_id, payment_option, receiver_name, receiver_phone, dlvy_addr, dlvy_request, tran_status_code, order_date, dlvy_date) 
		VALUES(seq_transaction_tran_no.nextval, #{purchaseProd.prodNo}, #{buyer.userId}, #{paymentOption}, #{receiverName}, #{receiverPhone}, #{divyAddr}, #{divyRequest:VARCHAR},'1', SYSDATE,#{divyDate:DATE})
	</insert>

	
	<!-- product의 Read(select) ok-->
	<select id="getPurchaseByTranNo" parameterType="int" resultMap="purchaseSelectMap">
		SELECT tran_no, prod_no, buyer_id, payment_option, receiver_name, receiver_phone, dlvy_addr, dlvy_request, tran_status_code, order_date, dlvy_date
		FROM transaction
		WHERE tran_no=#{value}
	</select>
	
	<select id="getPurchaseByProdNo" parameterType="int" resultMap="purchaseSelectMap">
		SELECT tran_no, prod_no, buyer_id, payment_option, receiver_name, receiver_phone, dlvy_addr, dlvy_request, tran_status_code, order_date, dlvy_date
		FROM transaction
		WHERE prod_no=#{value}
	</select>
	
	<!-- product의 Read(selectList) ok-->
	
	<select id="getPurchaseList" parameterType="java.util.Map" resultMap="purchaseSelectMap">
		SELECT *
	  	FROM (	SELECT inner_table.* , ROWNUM AS row_seq
	  					FROM		(	SELECT t.* 
	  									FROM users u, transaction t 
	  									WHERE u.user_id = t.buyer_id and user_id = #{id}
	  									ORDER BY tran_no
										) inner_table
						WHERE ROWNUM &lt;= #{search.endRowNum} )
		WHERE row_seq BETWEEN #{search.startRowNum} AND #{search.endRowNum} 	
	</select>
	
	<!-- product의 Update(update) ok-->
	
	<update id="updatePurchase" parameterType="com.model2.mvc.service.domain.Purchase">
		UPDATE transaction
		SET 
		payment_option=#{paymentOption}, receiver_name=#{receiverName}, receiver_phone=#{receiverPhone}, dlvy_addr=#{divyAddr}, dlvy_request=#{divyRequest:VARCHAR}, dlvy_date=#{divyDate:DATE}
		WHERE tran_no=#{tranNo}
	</update>
	
	<update id="updateTranCode" parameterType="com.model2.mvc.service.domain.Purchase">
		UPDATE transaction SET tran_status_code=#{tranCode} WHERE tran_no=#{tranNo}
	</update>
	
	<select  id="getTotalCount"  parameterType="string"	 resultType="int">
	  	SELECT COUNT(*)
	  	FROM(	SELECT t.* 
	  					FROM users u, transaction t 
	  					WHERE u.user_id = t.buyer_id and user_id = #{id}
	  					ORDER BY tran_no
	  					) countTable						
	 </select>
	
</mapper>